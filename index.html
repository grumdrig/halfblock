<!DOCTYPE html>
<html>

<head>
<title>Halfblock</title>
<script type="text/javascript" src="gl-matrix.js"></script>
<script type="text/javascript" src="perlin.js"></script>
<script type="text/javascript" src="main.js"></script>
<link href='http://fonts.googleapis.com/css?family=Cousine' 
      rel='stylesheet' type='text/css'>
<!-- Shaders for wireframe selection box -->
<script id="wireframe-vs" type="x-shader/x-vertex">
  attribute vec3 aPos;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aPos, 1.0);
  }
</script>
<script id="wireframe-fs" type="x-shader/x-fragment">
  precision mediump float;
  void main(void) {
    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
  }
</script>

<!-- Shaders for particles -->
<script id="particle-vs" type="x-shader/x-vertex">
  attribute vec3 aInitialPos;
  attribute vec3 aVelocity;
  attribute float aBirthday;
  //attribute float aDeathday;
  attribute vec2 aTexCoord;

  uniform float uClock;
  uniform float uGravity;
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying vec2 vTexCoord;

  void main(void) {
    vTexCoord = aTexCoord;
    if (aBirthday > uClock /*|| uClock > aDeathday*/) {
      gl_Position = vec4(-9999.0, -9999.0, -9999.0, 1.0);
    } else {
      float age = uClock - aBirthday;
      vec3 pos = aInitialPos + age * aVelocity;
      pos.y -= 0.5 * uGravity * age * age;  // reduced gravity
      if (uClock == aBirthday) pos.y += 3.0;
      gl_Position = uPMatrix * uMVMatrix * vec4(pos, 1.0);
      gl_PointSize = clamp(50.0 / gl_Position.z, 1.0, 50.0);
    }
  }
</script>
<script id="particle-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSampler;
  varying vec2 vTexCoord;
  void main(void) {
    gl_FragColor = texture2D(uSampler, 
                             (vTexCoord + 2.0 * gl_PointCoord) / 256.0);
  }
</script>

<!-- Block shader -->
<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 aPos;
  attribute vec2 aTexCoord;
  attribute vec4 aLighting;
  attribute vec3 aColor;
  
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform float uFogDistance;
  uniform float uSunlight;

  const float lightScale = 7.8;
  const vec3 minLight = vec3(0.2, 0.2, 0.2);
  
  varying vec2 vTexCoord;
  varying vec3 vLighting;
  varying float vFog;
  
  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aPos, 1.0);
    vTexCoord = aTexCoord / 16.0;
    vLighting = minLight +
      aColor * max(aLighting.xyz,
                   uSunlight * vec3(aLighting.w, 
                                    aLighting.w, 
                                    aLighting.w)) / lightScale;
    float z = abs(gl_Position.z);  // Use length() if not enough fog at corners
    vFog = clamp(1.0 - exp(-z*z / (uFogDistance * uFogDistance)),
                 0.0, 1.0);
  }
</script>
<script id="shader-fs" type="x-shader/x-fragment">
  precision mediump float;

  varying vec2 vTexCoord;
  varying vec3 vLighting;
  varying float vFog;
  
  uniform sampler2D uSampler;
  uniform float uSunlight;

  void main(void) {
    vec4 textureColor = texture2D(uSampler, vTexCoord);
    if (textureColor.a <= 0.5) {
      discard;
    } else {
      textureColor = vec4(textureColor.rgb * vLighting, textureColor.a);
      textureColor = vFog * uSunlight * vec4(0.5,0.8,0.98,0) + (1.0 - vFog) * textureColor;
      gl_FragColor = textureColor;
    }
  }
</script>

<script id="twodee-vs" type="x-shader/x-vertex">
  attribute vec2 aPosition;
  uniform vec2 uResolution;
  uniform float uPointsize;
  void main() {
    gl_PointSize = uPointsize;
    vec2 reposition = 2.0 * aPosition * vec2(1,-1) / uResolution - 1.0;
    gl_Position = vec4(reposition, 0, 1);
  }
</script>
<script id="twodee-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec4 uColor;
  void main() {
    gl_FragColor = uColor;
  }
</script>

<!-- Blur shaders
     http://www.gamerendering.com/2008/10/11/gaussian-blur-filter-shader/ -->
<script id="blur-vs" type="x-shader/x-vertex">
  attribute vec2 aPos;
  varying vec2 vTexCoord;
  void main(void) {
    gl_Position = vec4(sign(aPos), 0.0, 1.0);
    vTexCoord = sign(aPos) * 0.5 + 0.5;
  }
</script>
<script id="blur-horizontal-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSrc; // the texture with the scene you want to blur
  varying vec2 vTexCoord;
 
  const float bsize = 1.0/256.0;
  void main(void) {
    vec4 sum = vec4(0.0);
 
    // Blur in x (horizontal)
    // Take nine samples, with the distance bsize between them
    sum += texture2D(uSrc, vTexCoord - vec2(4.0*bsize, 0.0)) * 0.05;
    sum += texture2D(uSrc, vTexCoord - vec2(3.0*bsize, 0.0)) * 0.09;
    sum += texture2D(uSrc, vTexCoord - vec2(2.0*bsize, 0.0)) * 0.12;
    sum += texture2D(uSrc, vTexCoord - vec2(    bsize, 0.0)) * 0.15;
    sum += texture2D(uSrc, vTexCoord)                        * 0.16;
    sum += texture2D(uSrc, vTexCoord + vec2(    bsize, 0.0)) * 0.15;
    sum += texture2D(uSrc, vTexCoord + vec2(2.0*bsize, 0.0)) * 0.12;
    sum += texture2D(uSrc, vTexCoord + vec2(3.0*bsize, 0.0)) * 0.09;
    sum += texture2D(uSrc, vTexCoord + vec2(4.0*bsize, 0.0)) * 0.05;
    
    gl_FragColor = sum;
  }
</script>
<script id="blur-vertical-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSrc; // the texture rendered by the horizontal blur pass
  varying vec2 vTexCoord;
  const float bsize = 1.0/256.0;
  void main(void) {
    vec4 sum = vec4(0.0);
 
    // Blur in y (vertical)
    // Take nine samples, with the distance bsize between them
    sum += texture2D(uSrc, vTexCoord - vec2(0.0, 4.0*bsize)) * 0.05;
    sum += texture2D(uSrc, vTexCoord - vec2(0.0, 3.0*bsize)) * 0.09;
    sum += texture2D(uSrc, vTexCoord - vec2(0.0, 2.0*bsize)) * 0.12;
    sum += texture2D(uSrc, vTexCoord - vec2(0.0,     bsize)) * 0.15;
    sum += texture2D(uSrc, vTexCoord)                        * 0.16;
    sum += texture2D(uSrc, vTexCoord + vec2(0.0,     bsize)) * 0.15;
    sum += texture2D(uSrc, vTexCoord + vec2(0.0, 2.0*bsize)) * 0.12;
    sum += texture2D(uSrc, vTexCoord + vec2(0.0, 3.0*bsize)) * 0.09;
    sum += texture2D(uSrc, vTexCoord + vec2(0.0, 4.0*bsize)) * 0.05;
    
    gl_FragColor = sum;
  }
</script>

<!-- Blit -->
<script id="blit-vs" type="x-shader/x-vertex">
  attribute vec2 aPos;
  varying vec2 vTexCoord;
  void main(void) {
    gl_Position = vec4(sign(aPos), 0.0, 1.0);
    vTexCoord = sign(aPos) * 0.5 + 0.5;
  }
</script>
<script id="blit-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform sampler2D uSrc;
  varying vec2 vTexCoord;
 
  void main(void) {
    gl_FragColor = texture2D(uSrc, vec2(vTexCoord.x, vTexCoord.y));
  }
</script>

<!-- Skybox shaders -->
<script id="skybox-vs" type="x-shader/x-vertex">
  attribute vec3 aPos;
  void main(void) {
    gl_Position = vec4(aPos, 1.0);
  }
</script>
<script id="panorama-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 uViewport;
  uniform mat4 uInvProj;
  uniform mat3 uInvViewRot;
  uniform samplerCube uSampler;
  void main(void) {
    vec2 frag_coord = 2.0 * gl_FragCoord.xy / uViewport - 1.0;
    vec4 device_normal = vec4(frag_coord, 0.0, 1.0);
    vec3 eye_normal = normalize((uInvProj * device_normal).xyz);
    vec3 world_normal = normalize(uInvViewRot * eye_normal);
    gl_FragColor = textureCube(uSampler, world_normal);
  }
</script>
<script id="sky-fs" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 uViewport;
  uniform mat4 uInvProj;
  uniform mat3 uInvViewRot;
  uniform float uTimeOfDay;
  const vec4 skyColor = vec4(0.5, 0.8, 0.98, 1.0);
  const float sunset = 0.2;
  void main(void) {
    vec2 frag_coord = 2.0 * gl_FragCoord.xy / uViewport - 1.0;
    vec4 device_normal = vec4(frag_coord, 0.0, 1.0);
    vec3 eye_normal = normalize((uInvProj * device_normal).xyz);
    vec3 world_normal = normalize(uInvViewRot*eye_normal);
    float sunlight = 0.5 - cos(uTimeOfDay) / 2.0;
    gl_FragColor = skyColor;
    float d = abs(dot(world_normal, vec3(0.0, 1.0, 0.0))) / sunset;
    if (d < 1.0) {
      float sunsetty = 1.0 - abs(sin(uTimeOfDay));
      vec4 redness = mix(vec4(1,0,0,1), skyColor, sunsetty);
      gl_FragColor = sunlight * mix(redness, skyColor, d);
    } else {
      gl_FragColor = sunlight * skyColor;
    }
  }
</script>

<style>
body {
  height: 100%;
  width: 100%;
  margin: auto;
  margin-top: 20px;
  background-color: black;
}

#cancan {
  position: relative;
  margin: auto auto;
}


#cancan, #hud, #stats, #title, #pause, #loading, #inventory, #options {
  width: 854px;
  height: 480px;
}

#cancan:-webkit-full-screen,
:-webkit-full-screen #canvas,
:-webkit-full-screen #hud,
:-webkit-full-screen #options,
:-webkit-full-screen #stats {
  width: 100%;
  height: 100%;
}

#hud, #pause, #loading, #inventory, #title, #options {
  display: none;
}

#hud, #stats, #title, #pause, #loading, #inventory, #options {
  font-family: Cousine, sans-serif;
  font-size: 18px;
  position: absolute;
  top: 0;
  left: 0;
  color: white;
}

#loading div {
  text-align: center;
  font: 24px Cousine, sans-serif;
  position: absolute;
  margin-top: -20px;
  top: 50%;
  text-align: center;
  width: 100%;
  height: 40px;
  left: 0;
}

button {
  font-size: 20px;
  font-family: Cousine, sans-serif;
  position: absolute;
  left: 50%;
  width: 220px;
  height: 40px;
  margin-left: -110px;
  color: black;
}
#resumegame {
  top: 190px;
}
#newgame, #savegame {
  top: 250px;
}
#loadgame, #quitgame {
  top: 310px;
}

#reticule {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 24px;
  height: 24px;
  margin-top: -12px;
  margin-left: -12px;
}

.logo {
  position: absolute;
  left: 50%;
  top: 60px;
  width: 442px;
  height: 93px;
  margin-left: -221px;
  transition: opacity 1s ease-in-out;
  -moz-transition: opacity 1s ease-in-out;
  -webkit-transition: opacity 1s ease-in-out;
}

#warning, #incompatible {
  position: absolute;
  left: 50%;
  top: 60%;
  width: 80%;
  margin-left: -40%;
  margin-top: -24px;
  height: 48px;
  font-size: 20px;
  color: red;
  text-align: center;
  display: none;
}

.toolbox {
  position: absolute;
  width: 48px;
  height: 48px;
  border: solid 2px rgb(128, 128, 128);
  background: rgba(128, 128, 128, 0.5);
}
#toolbox {
  left: 16px;
  bottom: 3.33%;
}

#toolname {
  position: absolute;
  height: 16px;
  width: 300px;
  left: 80px;
  bottom: 5%;
}

.tool {
  background: transparent;
}

#terrain {
  display: none;
}

#chat {
  position: absolute;
  width 93%;
  height: 83%;
  top: 0px;
  left: 16px;
  color: white;
  overflow-y: hidden;
}

#clog {
  height: 400px;
}

</style>
</head>


<body onload="onLoad()">
  <div id="cancan">
    <canvas id="canvas" width="854" height="480"></canvas>
    <div id="hud">
      <div id="reticule">
        <img src="reticule.png" height="24" width="24">
      </div>
      <div id="toolname"></div>
      <div id="toolbox" class="toolbox">
        <canvas id="tool" class="tool" width="48" height="48"></canvas>
      </div>
      <div id="warning">&uarr;<br>Center mouse pointer to enable mouselook</div>
      <div id="chat"><div id="clog">&nbsp;</div></div>
    </div>
    <div id="stats"></div>
    <div id="options">
      <input id="anisotropic" type="checkbox">
      <label for="anisotropic">Anisotropic filtering</label>
    </div>
    <div id="title">
      <div class="logo"><img src="logo.png"></div>
      <button id="newgame">New Game</button>
      <button id="loadgame">Load Game</button>
      <div id="incompatible">This browser does not support mouse
        pointer locking, so Halfblock won't run here. Try the latest
        version of Chrome or Firefox.</div>
    </div>
    <div id="pause">
      <button id="resumegame">Return to Game</button>
      <button id="savegame">Save Game &amp; Quit</button>
      <button id="quitgame">Quit Game</button>
    </div>
    <div id="loading"><div>Loading...</div></div>
    <div id="inventory"></div>
  </div>
  <img src="terrain.png" id="terrain">
</body>

</html>
